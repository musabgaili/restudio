<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Virtual Tour Editor</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"
    rel="stylesheet"
  />
  <style>
    #viewer { width: 100%; height: 400px; border: 1px solid #ccc; margin-bottom: 1rem; }
    #imageList { margin-bottom: 1rem; }
    #hotspotsJson { white-space: pre-wrap; background: #f8f9fa; padding: .5rem; }
  </style>
</head>
<body class="container py-4">

  <h3>Virtual Tour Editor</h3>

  <!-- Upload multiple -->
  <input type="file" id="imageInput" accept="image/*" multiple class="form-control my-2" />

  <!-- Image List -->
  <div id="imageList" class="btn-group"></div>

  <!-- Viewer -->
  <div id="viewer"></div>

  <!-- Export -->
  <button class="btn btn-primary mb-3" id="exportBtn">Export Hotspots JSON</button>
  <div id="hotspotsJson" class="border rounded"></div>

  <!-- Modal for Hotspot -->
  <div class="modal fade" id="hotspotModal" tabindex="-1" aria-labelledby="hotspotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="hotspotForm">
          <div class="modal-header">
            <h5 class="modal-title" id="hotspotModalLabel">Add Hotspot</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="hotspotPitch" />
            <input type="hidden" id="hotspotYaw" />
            <div class="mb-3">
              <label class="form-label">Hotspot Type</label>
              <select id="hotspotType" class="form-select">
                <option value="info">Info</option>
                <option value="link">Link</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Text / Target</label>
              <input type="text" id="hotspotText" class="form-control" required />
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Add Hotspot</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
  <script>
    let viewer;
    const images = {};
    const hotspots = {};
    let currentImageKey = null;

    const modal = new bootstrap.Modal(document.getElementById('hotspotModal'));

    // Load multiple images
    document.getElementById('imageInput').addEventListener('change', e => {
      const files = Array.from(e.target.files);
      const listContainer = document.getElementById('imageList');
      listContainer.innerHTML = '';

      files.forEach((file, idx) => {
        const key = `img_${idx}`;
        const url = URL.createObjectURL(file);
        images[key] = url;
        hotspots[key] = [];

        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-secondary';
        btn.textContent = file.name;
        btn.addEventListener('click', () => loadImage(key));
        listContainer.appendChild(btn);

        // Load first image automatically
        if (idx === 0) loadImage(key);
      });
    });

    // Load selected image into viewer
    function loadImage(key) {
      currentImageKey = key;
      if (viewer) viewer.destroy();

      viewer = pannellum.viewer('viewer', {
        type: 'equirectangular',
        panorama: images[key],
        autoLoad: true,
        hotSpots: hotspots[key],
      });

      viewer.on('mousedown', event => {
        const [pitch, yaw] = viewer.mouseEventToCoords(event);
        document.getElementById('hotspotPitch').value = pitch;
        document.getElementById('hotspotYaw').value = yaw;
        modal.show();
      });
    }

    // Add hotspot from modal
    document.getElementById('hotspotForm').addEventListener('submit', e => {
      e.preventDefault();
      const pitch = parseFloat(document.getElementById('hotspotPitch').value);
      const yaw = parseFloat(document.getElementById('hotspotYaw').value);
      const type = document.getElementById('hotspotType').value;
      const text = document.getElementById('hotspotText').value;

      const hs = { pitch, yaw, type, text };
      hotspots[currentImageKey].push(hs);
      viewer.addHotSpot(hs);
      modal.hide();
      e.target.reset();
    });

    // Export all hotspots
    document.getElementById('exportBtn').addEventListener('click', () => {
      document.getElementById('hotspotsJson').textContent =
        JSON.stringify(hotspots, null, 2);
    });
  </script>
</body>
</html>
